<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/paper-card/paper-card.html">
<link rel="import" href="../bower_components/paper-button/paper-button.html">
<link rel="import" href="../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="shared-styles.html">


<dom-module id="view-algorithm">
  <template>
    <style include="shared-styles">
      :host {
        display: block;

        padding: 10px;
      }
      paper-card {
        width: 100%;
        margin-bottom:10px;
      }
      paper-card.white {
        --paper-card-header-color: #fff;
      }
      a {
          text-decoration: none !important;
          color:inherit;
      }
      #input_container{
        overflow:hidden;
      }
      /*TODO THIS SHOULD BE FIX*/
      .color0{
        border:1px solid #BBDEFB;
        overflow:hidden;
        display:inline-block;
        margin:5px;
      }
      .color1{
        border:1px solid #F8BBD0;
        overflow:hidden;
        display:inline-block;
        margin:5px;
      }
      .color2{
        border:1px solid #FFCDD2;
        overflow:hidden;
        display:inline-block;
        margin:5px;
      }
      .color3{
        border:1px solid #E1BEE7;
        overflow:hidden;
        display:inline-block;
        margin:5px;
      }
      .color4{
        border:1px solid #B2EBF2;
        overflow:hidden;
        display:inline-block;
        margin:5px;
      }
      .color99{
        overflow:hidden;
        display:inline-block;
        margin:5px;
      }
    </style>
    <app-route
            route="[[route]]"
            pattern="/:algorithm"
            data="{{routeData}}"></app-route>

<!-- //TODO Create config file dev and production, choose between environments -->
    <iron-ajax auto
    url="[[petitionUrl]]"
    params='{}'
    handle-as="json"
    last-response="{{algorithmDetails}}"></iron-ajax>
    <!-- <div class="card">
      <div class="circle">2</div>
      <h1>[[algorithmDetails.name]]</h1>
      <p>[[algorithmDetails.description]]</p>
    </div> -->
    <paper-card heading="[[algorithmDetails.name]]" image="[[algorithmDetails.images.banner]]" alt="[[algorithmDetails.name]]" class="white">
      <div class="card-content">
        [[algorithmDetails.description]]
      </div>
      <div class="card-actions">
        <h2>Inputs:</h2>
        <div id="input_container">
        </div>

          <paper-button on-tap="postData" raised>Process Data</paper-button>
          <iron-ajax
          id="processAjax"
          handle-as="json"
          content-type="application/json"
          method="POST"
          on-response="postComplete"
          last-response="{{processResponse}}"></iron-ajax>
      </div>

      <div class="card-actions">
        <h2>Result:</h2>
        <div id="output_container">
        </div>
      </div>
    </paper-card>
  </template>

  <script>
    Polymer({
      is: 'view-algorithm',
      properties: {
        route: Object,
        routeData:{
          type: Object,
          observer: '_routeChanged'
        },
        algorithmDetails: {
            type: Object,
            observer: '_ajaxResponse'
        },
        algorithm: {
          type: String,
          observer: '_algorithmChanged'
        }

      },
      postComplete: function() {
        console.log("Result",this.processResponse.result);
        // Get keys from json
        outputComponents = Object.keys(this.processResponse.result);
        // Load page import on demand. Show 404 page if fails
        var resolvedPageUrl = "";




        //create component
        var index = 0;
        for (index = 0; index < outputComponents.length; ++index) {
          resolvedPageUrl = this.resolveUrl( 'http://localhost:8080/outputData/' + outputComponents[index] + '/' + outputComponents[index] + '.html');
          this.importHref(resolvedPageUrl, null, this._showPage404, true);
          this.createComp(this.$.output_container, outputComponents[index],99, JSON.stringify(this.processResponse.result[outputComponents[index]]));

        }
      },

      _collectData: function() {
        var dataCollected = {};
        //TODO SUPPORT multiple elements same type.
        for (index = 0; index < this.algorithmDetails.inputData.length; ++index) {
          var name = this.algorithmDetails.inputData[index];
          var component = this.shadowRoot.querySelector(name);
          dataCollected[name]=component.output[name];
        }
        return dataCollected;
      },
      postData: function() {
        //Empty container
        Polymer.dom(this.$.output_container).innerHTML = "";

        var ironAjax = this.shadowRoot.querySelector('#processAjax');

        ironAjax.body = JSON.stringify({input:{data:this._collectData()}});
        ironAjax.url = this.petitionUrl;
        ironAjax.generateRequest();
      },
      _routeChanged: function(routeData) {
        this.algorithm = routeData.algorithm;
      },
      createComp: function(container, element, index, componentData) {
        var component = document.createElement(element);
        component.setAttribute("class", "color"+index);
        if (componentData) {
          component.setAttribute("input-data", componentData);
        }
        Polymer.dom(container).appendChild(component);
      },

      _ajaxResponse: function(algorithmDetails) {
          console.log("Response", algorithmDetails);
          // Load page import on demand. Show 404 page if fails
          var resolvedPageUrl = "";

          //Empty container
          Polymer.dom(this.$.input_container).innerHTML = "";

          //create component
          var index = 0;
          for (index = 0; index < algorithmDetails.inputData.length; ++index) {
            resolvedPageUrl = this.resolveUrl( 'http://localhost:8080/inputData/' + algorithmDetails.inputData[index] + '/' + algorithmDetails.inputData[index] + '.html');
            this.importHref(resolvedPageUrl, null, this._showPage404, true);
            this.createComp(this.$.input_container, algorithmDetails.inputData[index], index, null);
          }

      },

      _algorithmChanged: function(algorithm) {
        if(this.route.prefix == '/algorithm'){
          this.petitionUrl = 'http://localhost:3000/api/v1/algorithms/' + algorithm;
        }
      }
    });
  </script>
</dom-module>
