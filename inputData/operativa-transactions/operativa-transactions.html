<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">

<dom-module id="operativa-transactions">
  <template>
    <style include="shared-styles">
      :host {
        display: block;
        position: relative;
        height: 200px;
        min-width: 280px;
        overflow-y: auto !important;
        float: left;
      }

      .content {
        @apply(--layout-vertical);
        height: 100%;
      }

      .itemsList>div {
        @apply(--layout-flex);
        display: flex;
      }

      .itemsList>div>div {
        /*flex-grow: 1;*/
      }

      .itemsList {
        max-height: 240px;
      }

      .selectedList>div {
        float: left;
      }

      .item {
        @apply(--layout-horizontal);
        cursor: pointer;
        padding: 16px 22px;
        border-bottom: 1px solid #DDD;
      }

      .item:focus,
      .item.selected:focus {
        outline: 0;
        background-color: #ddd;
      }

      .item.selected .icon {
        color: var(--paper-blue-600);
      }

      .ticker {
        box-sizing: border-box;
        background-color: #009688;
        color: #fff;
        width: 90px;
        text-align: center;
        display: flex;
        justify-content: center;
        flex-direction: column;
      }

      .pad {
        @apply(--layout-flex);
        @apply(--layout-vertical);
        padding: 0 16px;
        max-width: 250px;
        /*width:100px;*/
      }

      .primary {
        font-size: 16px;
      }

      .secondary {
        font-size: 14px;
      }

      .dim {
        color: gray;
      }

      .icon {
        width: 24px;
        height: 24px;
        display: flex;
        justify-content: center;
        flex-direction: column;
      }

      .no-selection {
        color: #999;
        margin-left: 10px;
        line-height: 50px;
      }

      .itemsList {

        overflow-y: auto;
        @apply(--layout-flex);
      }

      .row:hover {
        background-color: #ECECEC;
      }

      .primary {
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden !important;
        max-width: 210px;
      }

      .lesswidth .primary {
        text-overflow: ellipsis;
        white-space: nowrap;
        overflow: hidden !important;
        max-width: 100px;
      }

      .dropdown-content {
        background-color: white;
        color: black;
        line-height: 20px;
        padding: 10px 0px;
        border-radius: 3px;
        text-transform: capitalize;
        /*box-shadow: 0px 2px 6px #ccc;*/
      }

      .equal {
        color: #FE5F55;
      }

      .down {
        color: #E63462;
      }

      .up {
        color: #C7EFCF;
      }

      .dropdown-content p {
        padding: 5px 15px;
      }

      .dropdown-content .selected {
        background-color: #ececec;
      }

      span.warning {
        color: var(--google-red-700);
      }

      .hide {
        display: none;
      }
    </style>
    <div class$="[[_setClass(visible)]]">
      <p>Transactions</p>
      <div class="itemsList lesswidth">
        <template is="dom-repeat" items="[[selectedItems]]">
          <div class="row" aria-label$="Select/Deselect">
            <div class="ticker">
              <paper-dropdown-menu label="Ticker">
                <paper-listbox index$="[[index]]" slot="dropdown-content" class="dropdown-content" attr-for-selected="value" on-selected-item-changed="updateTicker">
                  <template is="dom-repeat" items="[[listTickers]]" as="ticker">
                    <paper-item value="[[ticker]]">[[ticker]]</paper-item>
                  </template>
                </paper-listbox>
              </paper-dropdown-menu>
            </div>
            <div class="pad">
              <paper-input index$="[[index]]" on-input='updateShares' class="innerInput" type="number">
                <div suffix>Shares</div>
              </paper-input>
            </div>
            <div class="pad">
              <paper-dropdown-menu label="Action">
                <paper-listbox index$="[[index]]" slot="dropdown-content" class="dropdown-content" attr-for-selected="value" on-selected-item-changed="updateAction">
                  <paper-item value="buy">Buy</paper-item>
                  <paper-item value="sell">Sell</paper-item>
                </paper-listbox>
              </paper-dropdown-menu>
            </div>
            <div class="pad">
              <paper-input label="dd/mm/YYYY" index$="[[index]]" on-input='updateDate' auto-validate pattern="[0-9]{2}\/[0-9]{2}\/[0-9]{4}">
              </paper-input>
            </div>
          </div>
          <div class="border"></div>

        </template>
        <paper-button on-tap='_addRow' href="#">Add row</paper-button>
        <paper-button on-tap='_removeRow' href="#">Remove row</paper-button>

      </div>
    </div>


  </template>

  <script>
    Polymer({
      is: 'operativa-transactions',
      properties: {
        output: {
          type: Array,
          reflectToAttribute: true,
          notify: true,
        },
        visible: {
          type: Boolean,
          value: false
        },
        selectedItems: {
          type: Array,
          value: []
        },
        listTickers: {
          type: Array,
          value: []
        },
      },
      _removeRow() {
        let items = this.selectedItems;
        items.splice(-1,1);
        this.set('selectedItems',[]);
        this.set('selectedItems',items);
        this.output = {
          "operativa-transactions": items
        };
        // this.set('selectedItems',e.detail);
        // this.selectedItems = items;
      },
      _addRow() {
        let items = this.selectedItems;
        items.push({'name': '', 'no_shs': 0, 'buy_sell': '', 'date': ''});
        this.set('selectedItems',[]);
        this.set('selectedItems',items);
        // this.set('selectedItems',e.detail);
        // this.selectedItems = items;
      },
      updateShares: function (e) {
        const index = e.currentTarget.attributes.index.value;
        const value = parseInt(e.currentTarget.value, 10);
        let items = this.selectedItems;
        items[index].no_shs = value;
        this.output = {
          "operativa-transactions": items
        };
        // console.log("NEW",{
        //   "operativa-transactions": items
        // },this.output);
      },
      updateDate: function (e) {
        const index = e.currentTarget.attributes.index.value;
        const value = e.currentTarget.value;

        let items = this.selectedItems;
        items[index].date = value;
        this.output = {
          "operativa-transactions": items
        };
      },
      updateAction: function (e) {
        const index = e.currentTarget.attributes.index.value;
        const value = e.currentTarget.selected;

        let items = this.selectedItems;
        items[index].buy_sell = value;
        this.output = {
          "operativa-transactions": items
        };
      },
      updateTicker: function (e) {
        const index = e.currentTarget.attributes.index.value;
        const value = e.currentTarget.selected;
// debugger;
        let items = this.selectedItems;
        items[index].name = value;
        this.output = {
          "operativa-transactions": items
        };
      },
      attached: function () {
        this.attachedShowItemsFn = this.updateSelected.bind(this);
        this.attachedShowComponentFn = this.updateLayout.bind(this);

        this.fetcher = document;
        this.fetcher.addEventListener('tickers-list-operativa-updated', this.attachedShowItemsFn);
        this.fetcher.addEventListener('operativa-verificador-updated', this.attachedShowComponentFn);
      },
      detached: function () {
        this.fetcher.removeEventListener('tickers-list-operativa-updated', this.attachedShowItemsFn);
        this.fetcher.removeEventListener('operativa-verificador-updated', this.attachedShowComponentFn);

        // the detached method is called when the component is removed.
        // Hence, we need to remove external references.
        this.fetcher = null;
      },
      updateLayout: function (e) {
        if (!e.detail) {
          this.output = {
            "operativa-transactions": []
          };
          // this.selectedItems = [];
        }
        this.set('visible', e.detail);
      },
      updateSelected: function (e) {
        const userViews = [];
        for (var i = 0; i < e.detail.length; i++) {
          userViews.push(e.detail[i].name);
          // if (!this.output['operativa-transactions'][e.detail[i].name]) {
          //   userViews[e.detail[i].name]={'no_shs':0,
          //                            'buy_sell':'',
          //                            'date':''
          //                            };
          // }else {
          //   userViews[e.detail[i].name]=this.output['operativa-transactions'][e.detail[i].name];
          // }
        }
        // this.listTickers = userViews;
        this.set('listTickers',[]);
        this.set('listTickers',userViews);
        console.log(userViews);
        // this.output = {
        //   "operativa-transactions": userViews
        // };
        // this.set('selectedItems',[]);
        // this.set('selectedItems',e.detail);
      },
      ready: function () {
        this.output = {
          "operativa-transactions":[] 
        };
      },
      _setClass: function (visible) {
        return (visible) ? 'none' : 'hide';
      }
    });
  </script>
</dom-module>